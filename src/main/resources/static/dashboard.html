<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <style>
        body {
            background-color: #f5f7fa;
        }

        .container-box {
            margin-top: 40px;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .top-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

<div class="container container-box">

    <!-- TOP BUTTONS -->
    <div class="top-actions">
        <button class="btn btn-danger" onclick="logout()">Sign Out</button>
        <button class="btn btn-success" onclick="goToDonation()">Make Donation</button>
    </div>

    <!-- USER INFO -->
    <div class="card p-4 mb-4">
        <h4>User Profile</h4>
        <p><strong>Full Name:</strong> <span id="fullName"></span></p>
        <p><strong>Email:</strong> <span id="email"></span></p>
    </div>

    <!-- DONATION LIST -->
    <div class="card p-4">
        <h4>My Donations</h4>

        <table class="table table-bordered mt-3">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Organization</th>
                <th>Category</th>
            </tr>
            </thead>

            <tbody id="donationTableBody">
            </tbody>
        </table>
    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

    // =============================
    // LOAD DASHBOARD DATA
    // =============================
    fetch("http://localhost:8080/api/public/donation", {
        method: "GET",
        credentials: "include"
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("Unauthorized");
            }
            return response.json();
        })
        .then(data => {

            const user = data.userDTO;

            document.getElementById("fullName").innerText =
                user.firstName + " " + user.lastName;

            document.getElementById("email").innerText =
                user.email;

            const donations = data.li;
            const tableBody = document.getElementById("donationTableBody");
            tableBody.innerHTML = "";

            donations.forEach(donation => {

                const row = `
          <tr>
            <td>${donation.donationId}</td>
            <td>${donation.description}</td>
            <td>${donation.donationAmount}</td>
            <td>${donation.organizationName}</td>
            <td>${donation.categoryName}</td>
          </tr>
        `;

                tableBody.innerHTML += row;
            });

        })
        .catch(error => {
            alert("You are not authorized. Please login again.");
            window.location.href = "login.html";
        });

    // =============================
    // LOGOUT
    // =============================
    function logout() {
        fetch("http://localhost:8080/auth/signout", {
            method: "POST",
            credentials: "include"
        })
            .then(() => {
                window.location.href = "login.html";
            });
    }

    // =============================
    // REDIRECT TO DONATION PAGE
    // =============================
    function goToDonation() {
        window.location.href = "checkout.html";
    }

</script>

</body>
</html>
